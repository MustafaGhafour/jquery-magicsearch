"use strict";function _toConsumableArray(t){if(Array.isArray(t)){for(var i=0,e=Array(t.length);i<t.length;i++)e[i]=t[i];return e}return Array.from(t)}!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t("undefined"!=typeof jQuery?jQuery:window.Zepto)}(function(t){var i=8,e=13,s=27,o=32,a=37,r=38,n=39,d=40,h="magicsearch-wrapper",l="magicsearch-box",p="magicsearch-arrow",c="magicsearch-loading",u="magicsearch-hidden",f="multi-items",m="multi-item",g="multi-item-close",v=function(i){return"string"===t.type(i)},w=function(t,i){var e=t.match(new RegExp("\\%[^\\%]+\\%","g"));if(!e)return t;for(var s=0;s<e.length;s++)e[s]=e[s].replace(new RegExp("\\%","g"),"");for(var o=0;o<e.length;o++)t=t.replace("%"+e[o]+"%",i[e[o]]?i[e[o]]:"error");return t},S=function(t){var i=t.lastIndexOf("px");return i<0?Number(t):Number(t.substring(0,i))},y=function(i,e){return t.isNumeric(i)?(i=Math.ceil(Number(i)))<=0&&(i=b.defaults[e]):i=b.defaults[e],i},b=function(i,e){this.element=i,this.$element=t(i),this.options=e};b.defaults={dataSource:[],type:"",ajaxOptions:{},AjaxUrl:"",id:"",hidden:!1,fields:"",format:"",inputFormat:"",maxShow:5,isClear:!0,showSelected:!0,dropdownBtn:!1,dropdownMaxItem:8,multiple:!1,maxItem:!0,showMultiSkin:!0,multiStyle:{},multiField:"",focusShow:!1,noResult:"",skin:"",disableRule:function(t){return!1},success:function(t,i){return!0},afterDelete:function(t,i){return!0}},b.prototype={init:function(){var i=this;window.MagicSearch.index+=1;var e=this.$element;if(this.options=t.extend({},b.defaults,this.options),this.props={isFirstGetDataSource:!0,style:t.extend({},this.element.style),objDataSource:{},multiStyle:{space:3,width:57}},!this.$element.is("input:text"))return console.error("magicsearch: Can not bind magicsearch to other elements except input which type is text."),!1;if(!v(this.options.id)||""===this.options.id)return console.error("magicsearch: The option id must be a string which is not empty."),!1;this.options.multiple?this.options.isClear=!0:this.options.isClear||(this.options.hidden=!1),this.props.styles={borderTopWidth:S(e.css("border-top-width")),borderRightWidth:S(e.css("border-right-width")),borderBottomWidth:S(e.css("border-bottom-width")),borderLeftWidth:S(e.css("border-left-width")),paddingTop:S(e.css("padding-top")),paddingRight:S(e.css("padding-right")),paddingBottom:S(e.css("padding-bottom")),paddingLeft:S(e.css("padding-left")),maxWidth:S(e.css("max-width"))||500},this.props.styles.height=e.height()+this.props.styles.borderTopWidth+this.props.styles.borderBottomWidth+this.props.styles.paddingTop+this.props.styles.paddingBottom,this.props.styles.sightHeight=this.props.styles.height-this.props.styles.borderTopWidth-this.props.styles.borderBottomWidth,this.props.styles.width=e.width()+this.props.styles.borderLeftWidth+this.props.styles.borderRightWidth+this.props.styles.paddingLeft+this.props.styles.paddingRight;var s=this.props.styles,o=e.attr("data-id");if("magicsearch"!==e.parent().attr("data-belong")){var a=t('<div class="'+h+(this.options.skin?" "+this.options.skin:"")+'" data-belong="magicsearch"></div>');a.css("width",s.width),e.wrap(a)}var r=e.parent(),n=e.css("display");if(r.css({display:"inline"===n?"inline-block":n,float:e.css("float"),margin:e.css("margin")}),r.attr("data-index",window.MagicSearch.index),e.css({margin:0,"box-sizing":"border-box",width:s.width,height:s.height}),e.attr("placeholder")&&e.attr("data-placeholder",e.attr("placeholder")),e.removeAttr("disabled"),this.options.isClear&&e.val(""),void 0===o&&(e.attr("data-id",""),o=""),0===r.find("."+l).length&&r.append('<div class="'+l+'"></div>'),r.find("."+l).css({top:s.height}),this.options.hidden){var d=e.attr("name"),f=t('<input class="'+u+'" type="hidden" value="'+o+'">');d&&(f.attr("name",d),e.removeAttr("name")),r.append(f)}if(this.options.dropdownBtn){var m=t('<div class="'+p+'"><i></i></div>');e.addClass("dropdown"),e.css("padding-right",s.paddingRight+24),m.css({top:s.borderTopWidth,bottom:s.borderBottomWidth,right:s.borderRightWidth}),r.append(m)}if("ajax"==this.options.type){var g=t('<div class="'+c+'"><div></div></div>');r.append(g);var w=setTimeout(function(){r.find("."+c).find("div").show()},500),y={type:"GET",url:this.options.dataSource,dataType:"json",error:function(){console.error("magicsearch: Error with xhr.Index: "+window.MagicSearch.index)},success:function(t){}},x=(y=t.extend({},y,this.options.ajaxOptions)).success;y.success=function(t){clearTimeout(w),i.options.dataSource=t,r.find("."+c).remove(),i.initAfterAjax(),x(t)},t.ajax(y)}else this.initAfterAjax();return this},initAfterAjax:function(){var i=this.$element,e=i.parent(),s=this.props.styles,o=i.attr("data-id");if(t.isFunction(this.options.dataSource)&&(this.options.dataSource=this.options.dataSource(this.$element)),this.options.dataSource){if(v(this.options.dataSource))if("null"==this.options.dataSource.toLowerCase())this.options.dataSource=[];else try{if(this.options.dataSource=t.parseJSON(this.options.dataSource),!t.isArray(this.options.dataSource)){var a=[];for(var r in this.options.dataSource)a.push(this.options.dataSource[r]);this.options.dataSource=a}}catch(t){return this.options.dataSource=[],console.error("magicsearch: A problem is occured during parsing dataSource,please check.Index: "+window.MagicSearch.index),!1}else if(!t.isArray(this.options.dataSource)){var n=[];for(var d in this.options.dataSource)n.push(this.options.dataSource[d]);this.options.dataSource=n}}else this.options.dataSource=[];if(v(this.options.fields)?this.options.fields=[""===this.options.fields?this.options.id:this.options.fields]:t.isArray(this.options.fields)||(this.options.fields=[this.options.id]),v(this.options.format)&&""!==this.options.format||(this.options.format="%"+this.options.id+"%"),this.options.maxShow=y(this.options.maxShow,"maxShow"),this.options.dropdownBtn&&(this.options.dropdownMaxItem=y(this.options.dropdownMaxItem,"dropdownMaxItem")),this.options.multiple&&(!0!==this.options.maxItem&&(this.options.maxItem=y(this.options.maxItem,"maxItem")),this.options.showMultiSkin&&(v(this.options.multiField)&&""!==this.options.multiField||(this.options.multiField=this.options.id)),this.options.multiStyle&&(this.props.multiStyle.space=this.options.multiStyle.space?this.options.multiStyle.space:3,this.props.multiStyle.width=this.options.multiStyle.width?this.options.multiStyle.width:57)),t.isFunction(this.options.success)||(this.options.success=function(t,i){return!0}),t.isFunction(this.options.disableRule)||(this.options.disableRule=function(t){return!1}),""!==o&&this.getDataSource(),this.options.multiple&&(i.addClass("multi"),this.options.showMultiSkin&&0===e.find("."+f).length)){var h=t('<div class="'+f+'"></div>');h.css({top:this.props.multiStyle.space+s.borderTopWidth,left:this.props.multiStyle.space+s.borderLeftWidth,bottom:this.props.multiStyle.space+s.borderBottomWidth,right:this.props.multiStyle.space+s.borderRightWidth+(this.options.dropdownBtn?24:0)}),e.append(h)}if(this.options.multiple){var l=o?o.split(","):[];if(!0!==this.options.maxItem&&l.length>=this.options.maxItem&&(i.attr("disabled","disabled"),e.addClass("disabled")),this.options.showMultiSkin)for(var p=[],c=0;c<l.length;c++)p.push(l[c]),i.attr("data-id",p.join(",")),this.options.hidden&&e.find("."+u).val(p.join(",")),this.appendHtml(this.props.objDataSource[l[c]])}else if(""!==o){var m=this.props.objDataSource[o],g=this.options.inputFormat?this.options.inputFormat:this.options.format;i.val(w(g,m))}},destroy:function(){var t=this.$element,i=t.parent();if("magicsearch"===i.attr("data-belong")){this.element.style=this.props.style,t.css({margin:i.css("margin"),"padding-top":this.props.styles.paddingTop,"padding-right":this.props.styles.paddingRight,"padding-bottom":this.props.styles.paddingBottom,"padding-left":this.props.styles.paddingLeft,height:this.props.styles.height,width:this.props.styles.width});var e=t.attr("data-placeholder");void 0!==e&&(t.attr("placeholder",e),t.removeAttr("data-placeholder")),t.removeClass("dropdown multi").removeAttr("disabled data-id"),t.siblings().remove(),t.unwrap(),t.off(),t.val("")}},getDataSource:async function(){var i=this;t.get(i.options.AjaxUrl+"?criteria="+t(i)[0].$element.val(),function(t){t,i.options.dataSource=t;var e=i.options.dataSource;if(i.props.isFirstGetDataSource){for(var s={},o=0;o<e.length;o++)for(var a in e[o])i.options.dataSource[o][a]=String(e[o][a]);i.props.isFirstGetDataSource=!1;for(var r=0;r<e.length;r++)s[e[r][i.options.id]]=e[r];i.props.objDataSource=s}return i.options.dataSource})},setData:function(){var t=this.$element,i=t.parent(),e=i.find("."+l),s=(i.find("."+p),e.find("li.ishover")),o=this.options,a=t.attr("data-id"),r=this.props.objDataSource[s.attr("data-id")];if(o.multiple){if(e.is(":hidden"))return;t.val("");var n=a?a.split(","):[];if(!0!==o.maxItem&&n.length>=o.maxItem)return this;n.push(s.attr("data-id")),!0!==o.maxItem&&n.length==o.maxItem&&(t.attr("disabled","disabled"),i.addClass("disabled")),t.attr("data-id",n.join(",")),o.hidden&&i.find("."+u).val(n.join(",")),o.showMultiSkin&&this.appendHtml(r)}else t.val(o.inputFormat?w(o.inputFormat,r):s.text()),t.attr("data-id",s.attr("data-id")),o.hidden&&i.find("."+u).val(s.attr("data-id"));return o.success(t,r),this},deleteData:function(i){var e=this.$element,s=e.parent(),o=s.find("."+l),a=(s.find("."+p),this),r=i?i.split(","):[],n=e.attr("data-id"),d=n?n.split(","):[],h=this.options,c=this.props.styles;if(!h.multiple)return i=e.attr("data-id"),e.val("").attr("data-id",""),h.hidden&&s.find("."+u).val(""),h.afterDelete(e,a.props.objDataSource[i]),this;for(var f=function(){t(this).remove()},g=0;g<r.length;g++)s.find("."+m+'[data-id="'+r[g]+'"]').fadeOut(400,f),d.splice(d.indexOf(r[g]),1);return setTimeout(function(){var t=parseInt((c.maxWidth-(h.dropdownBtn?24:0)-c.borderLeftWidth-c.borderRightWidth-a.props.multiStyle.space)/(a.props.multiStyle.width+a.props.multiStyle.space)),i=parseInt(d.length/t);if(e.attr("data-id",d.join(",")),h.hidden&&s.find("."+u).val(d.join(",")),s.removeClass("disabled"),e.removeAttr("disabled"),h.showMultiSkin&&(0===d.length&&e.attr("data-placeholder")&&e.attr("placeholder",e.attr("data-placeholder")),e.css("padding-left",d.length%t*(a.props.multiStyle.width+a.props.multiStyle.space)+c.paddingLeft),e.css("height",c.height+i*c.sightHeight),e.css("padding-top",i*c.sightHeight+c.paddingTop),o.css("top",c.height+i*c.sightHeight),0===i)){var n=(d.length%t+1)*(a.props.multiStyle.width+a.props.multiStyle.space)+2*a.props.multiStyle.space+c.borderLeftWidth+c.borderRightWidth+(h.dropdownBtn?24:0);e.css("min-width",n),s.css("min-width",n)}1==r.length&&h.afterDelete(e,a.props.objDataSource[r[0]])},400),this},searchData:async function(i,e){var s=this;t.get(s.options.AjaxUrl+"?criteria="+t(s)[0].$element.val(),function(o){o,s.options.dataSource=o;var a=s.options.dataSource;if(s.props.isFirstGetDataSource){for(var r={},n=0;n<a.length;n++)for(var d in a[n])s.options.dataSource[n][d]=String(a[n][d]);s.props.isFirstGetDataSource=!1;for(var h=0;h<a.length;h++)r[a[h][s.options.id]]=a[h];s.props.objDataSource=r}var p=s.$element,c=p.parent().find("."+l),u=s.options,f=o,m=p.attr("data-id"),g=m?m.split(","):[],v=t.trim(p.val()),S="",y=(o=[],!0);if(!0!==e&&c.html(""),""===v&&!i)return s;if(i){var b=p.data("page")||1;if(o=f.slice(0),!u.showSelected){n=0;for(var x=0;n<o.length;n++){if(g.indexOf(o[n][u.id])>-1&&(o.splice(n,1),n--,++x==g.length))break}}b<=Math.ceil(o.length/100)&&p.data("page",b+1),o=o.slice(100*(b-1),100*b),1!=b&&0===o.length&&(y=!1)}else{for(var C=[].concat(_toConsumableArray(new Set(v.toLowerCase().split(" ")))),B=[],D=0;D<C.length;D++)""!==C[D]&&B.push({value:C[D],flag:!1});for(var j=0;j<f.length;j++)if(u.showSelected||!g.includes(f[j][u.id])){B=B.map(function(t){return t.flag=!1,t});for(var A=0;A<u.fields.length;A++){for(var W=0;W<B.length;W++)null!==f[j][u.fields[A]]&&f[j][u.fields[A]].toLowerCase().includes(B[W].value)&&(B[W].flag=!0);if(B.every(function(t){return t.flag})){o.push(f[j]);break}}if(o.length>=u.maxShow)break}}if(0===o.length){var k=u.noResult?u.noResult:"&#x672a;&#x641c;&#x7d22;&#x5230;&#x7ed3;&#x679c;";S='<span class="no-result">'+k+"</span>"}else{for(var I=[].concat(_toConsumableArray(new Set(v.split(" ")))).filter(function(t){return""!==t}),M=[],R=0;R<I.length-1;R++)for(var T=R+1;T<I.length;T++)M.push(I[R]+" "+I[T]);I=I.concat(M);var F=void 0;i||(F=t.extend(!0,[],o),o.forEach(function(t,i){u.fields.forEach(function(e){var s=[];if(null!==t[e]){for(var o=0;o<t[e].length;o++)s[o]=0;I.forEach(function(i){if(t[e])try{var o=t[e].toLowerCase().indexOf(i.toLowerCase());if(o>-1)for(var a=o;a<i.length+o;a++)s[a]=1}catch{}})}for(var a=[],r=!1,n=-1,d=0,h=s.length-1;h>=0;h--)1==s[h]?(r?n--:(r=!0,n=h),d++,0===h&&a.push({start:n,length:d})):r&&(r=!1,a.push({start:n,length:d}),d=0);void 0!==F[i][e]&&(F[i][e]=a)})})),S+="<ul>",o.forEach(function(e,s){var o=t.extend({},e);S+='<li class="',S+=u.disableRule(e)?"disabled":"enabled",u.showSelected&&(S+=g.includes(e[u.id])?" selected":""),S+='" data-id="'+(void 0===e[u.id]?"":e[u.id])+'"',i||u.fields.forEach(function(t){null!==e[t]&&F[s][t].forEach(function(i){var e=o[t].substr(i.start,i.length);o[t]=o[t].replace(new RegExp(e,"i"),'<span class="keyword">'+e+"</span>")})}),S+=' title="'+w(u.format,e)+'">'+w(u.format,o)+"</li>"}),S+="</ul>"}return i?(y&&c.html(c.html()+S),c.addClass("all")):(c.html(S),c.removeClass("all").css("max-height","none")),s}).then(function(){var t=s.$element.parent(),i=t.find("."+l);if(i.is(":visible"))return!1;if(s.options.dropdownBtn){var e=t.find("."+p);e.removeClass("arrow-rotate-360"),e.addClass("arrow-rotate-180")}i.slideDown(200)})},showSearchBox:function(t){var i=this.$element.parent(),e=i.find("."+l);if(e.is(":visible"))return!1;if(this.options.dropdownBtn){var s=i.find("."+p);s.removeClass("arrow-rotate-360"),s.addClass("arrow-rotate-180")}return e.slideDown(200,t),this},hideSearchBox:function(t){var i=this.$element,e=i.parent(),s=e.find("."+l);if(!s.is(":visible"))return!1;if(void 0===t?this.options.isClear&&(this.options.multiple||""===i.attr("data-id"))&&i.val(""):t&&i.val(""),this.options.dropdownBtn){var o=e.find("."+p);o.removeClass("arrow-rotate-180"),o.addClass("arrow-rotate-360")}return setTimeout(function(){s.scrollTop(0)},199),s.slideUp(200,function(){s.html("")}),this},appendHtml:function(i){var e=this.$element,s=e.parent(),o=s.find("."+l),a=(s.find("."+p),o.find("li.ishover"),this.options),r=this.props.styles,n=this,d=e.attr("data-id").split(",");e.attr("placeholder")&&e.removeAttr("placeholder");var h=parseInt((r.maxWidth-(a.dropdownBtn?24:0)-r.borderLeftWidth-r.borderRightWidth-n.props.multiStyle.space)/(n.props.multiStyle.width+n.props.multiStyle.space)),c=t('<div class="'+m+'" data-id="'+i[a.id]+'" title="'+w(a.format,i)+'"><span>'+w(a.format,i)+'</span><a class="'+g+'" data-id="'+i[a.id]+'" href="javascript:;"></a></div>');c.css({height:r.sightHeight-2*n.props.multiStyle.space,width:n.props.multiStyle.width,"margin-bottom":2*n.props.multiStyle.space,"margin-right":n.props.multiStyle.space,"line-height":r.sightHeight-2*n.props.multiStyle.space-2+"px"}),c.find("."+g).css({top:parseInt((r.sightHeight-2*n.props.multiStyle.space-2-12)/2)});var u=parseInt(d.length/h);if(e.css("padding-left",r.paddingLeft+d.length%h*(n.props.multiStyle.width+n.props.multiStyle.space)),d.length%h==0)e.css("height",r.height+u*r.sightHeight),e.css("padding-top",u*r.sightHeight),o.css("top",r.height+u*r.sightHeight);else if(0===u){var v=(d.length%h+1)*(n.props.multiStyle.width+n.props.multiStyle.space)+2*n.props.multiStyle.space+r.borderLeftWidth+r.borderRightWidth+(a.dropdownBtn?24:0);e.css("min-width",v),s.css("min-width",v)}c.find("."+g).click(function(){n.deleteData(t(this).attr("data-id")).hideSearchBox()}),s.find("."+f).append(c)}},t.fn.magicsearch=function(c){var g=!1,w=null,S="",y=this.each(function(){var h=t(this),y=t.data(this,"magicsearch");if(y&&y.destroy(),!1!==(y=new b(this,c)).init()){t.data(this,"magicsearch",y);var x=y.options,C=h.parent(),B=C.find("."+l),D=function(){if(C.hasClass("disabled"))return!1;B.is(":visible")?y.hideSearchBox():(B.css({"max-height":30*x.dropdownMaxItem+8}),B.unbind("scroll"),h.data("page",1),y.searchData(!0).showSearchBox(function(){B.on("scroll",function(i){this.scrollHeight-t(this).scrollTop()<300&&y.searchData(!0,!0)})}))};h.off().on("keyup",function(h){var l=t(this);if(h.which==s)l.val("").focus(),y.hideSearchBox();else{if(h.which==d){var p=B.find("li"),c=B.find("li.ishover");return p.length>0&&(c.length>0?(c.toggleClass("ishover"),c.next().length>0?c.next().toggleClass("ishover"):B.find("li:first").toggleClass("ishover")):B.find("li:first").toggleClass("ishover")),!1}if(h.which==r){var u=B.find("li"),f=B.find("li.ishover");return u.length>0&&(f.length>0?(f.toggleClass("ishover"),f.prev().length>0?f.prev().toggleClass("ishover"):B.find("li:last").toggleClass("ishover")):B.find("li:last").toggleClass("ishover")),!1}if(h.which==e){var m=B.find("li.ishover");m.length>0&&m.trigger("click")}else{if(h.which==a||h.which==n)return!0;var g=l.val();if(t.trim(S)==t.trim(g))return!0;if(""!==g){if(""===t.trim(g))return y.hideSearchBox(h.which!=i&&h.which!=o&&void 0),!1;if(!x.multiple&&""!==l.attr("data-id"))return void y.hideSearchBox();clearTimeout(w),w=setTimeout(function(){y.searchData()},200)}else y.hideSearchBox()}}}).on("keydown",function(o){var h=t(this);if(o.which==s);else{if(o.which==r)return!1;if(o.which==d)return!1;if(o.which==e)return!B.is(":visible");if(o.which==i)if(S=h.val(),x.multiple){var l=C.find("."+f+" ."+m+":last");x.showMultiSkin&&""===h.val()&&y.deleteData(l.attr("data-id")).hideSearchBox()}else""!==t(this).attr("data-id")&&(y.deleteData(),y.hideSearchBox());else{if(o.which==a||o.which==n)return!0;if(""!==(S=h.val())&&!x.multiple&&""!==h.attr("data-id"))return void y.deleteData()}}}).on("focus",function(){C.addClass("focus"),x.isClear||""===h.val()||""!==h.attr("data-id")?x.focusShow&&D():y.searchData()}).on("blur",function(){C.removeClass("focus"),y.hideSearchBox()}),B.off().on("mousedown","ul",function(){return!1}).on("mouseenter","li",function(){t(this).parent().find("li.ishover").removeClass("ishover"),t(this).addClass("ishover")}).on("mouseleave","li",function(){t(this).removeClass("ishover")}).on("click","li",function(){var i=t(this);i.hasClass("selected")&&x.multiple?y.deleteData(i.attr("data-id")).hideSearchBox():y.setData().hideSearchBox()}),x.dropdownBtn&&(g=!0,C.on("click","."+p,function(){return D()})),h.on("clear",function(){h.val(""),x.multiple&&x.showMultiSkin?y.deleteData(h.attr("data-id")):(h.attr("data-id",""),x.hidden&&C.find("."+u).val(""))}).on("update",function(i,e){if(void 0!==e.dataSource){var s=e.dataSource;if(v(s))if("null"==e.dataSource.toLowerCase())s=[];else try{if(s=t.parseJSON(e.dataSource),!t.isArray(s)){var o=[];for(var a in s)o.push(s[a]);s=o}}catch(t){s=[],console.error("magicsearch: The dataSource you updated is wrong,please check.")}y.props.isFirstGetDataSource=!0,y.options.dataSource=s}}).on("set",function(t,i){var e=y.$element.attr("data-id"),s=y.options.multiple;y.destroy(),y.$element.attr("data-id",i.override||!s?i.id:[].concat(_toConsumableArray(new Set((e?e.split(","):[]).concat(i.id.split(",")))))),y.$element.magicsearch(y.options)}).on("destroy",function(){y.destroy()}),C.on("click","."+f,function(i){t(i.target).is("."+f)&&h.focus()}).on("mousedown","."+f,function(){return!1})}});return g&&!window.MagicSearch.hasBindBody&&(t("body").on("mousedown",function(i){var e=t(i.target),s=t(this).find("."+h+" ."+l+":visible").first().parent(),o=s.find("input:text"),a=s.attr("data-index");void 0===a||e.is("."+h+'[data-index="'+a+'"] *')||t.data(o.get(0),"magicsearch").hideSearchBox()}),window.MagicSearch.hasBindBody=!0),y},window.MagicSearch={v:"1.0.2",index:0,hasBindBody:!1}});
